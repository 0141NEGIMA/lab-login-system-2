# lab-login-system-2
Bluetooth機器が近くにあるかどうかで入退室状況を判断し，それを共有することができるサービスです．

## 機能
次の機能を提供します．

### 入退室状況表示
Notionのページに，メンバーの入退室状況をリアルタイムで表示します．

更新間隔は分単位で設定することができます．


### 週次レポート
毎週月曜日の9時に，各個人のSlackへ，先週1週間の入退室状況を画像でレポートします．

手動で週次レポートを一斉送信することもできます．


### メンバー管理
参加するメンバーの情報の編集ができます．

現在は以下の機能が利用可能です．
- 新規メンバーの作成
- 既存のメンバーの削除
- 既存のメンバーのMACアドレスの更新


## 使用方法
> [!IMPORTANT]
> `requirements.txt`を参照し，必ずPythonの仮想環境に必要なライブラリをインストールしてください．
>
> Pythonスクリプトの実行は，仮想環境をアクティベートした状態で，プロジェクトのルートディレクトリ`lab-login-system-2`から行ってください．

### 入退室記録・自動週次レポートの開始
> [!NOTE]
> 以下の操作によって，`main.py`と`weekly_report.py`の2つが実行され，入退室記録と自動週次レポートが同時に開始します．
>
> これらは，決まった時刻になると自動的に処理を行います．


1. 以下のスクリプトを実行してください．
   ```
   ./main.sh
   ```
2. Notionのページが正しく更新されるようになっていることを確認してください．


### 新規メンバーの作成
1. 次の情報を準備してください．
   - 登録したいユーザ名
     - 半角英数字が利用可能です．
   - スマートフォン等のMACアドレス
     - iPhoneの場合，「設定>一般>情報>Bluetooth」から確認できます．
   - SlackのメンバーID
     - Slackのユーザのアイコンをクリックし，「その他>メンバーIDをコピー」から確認できます．
2. 以下のスクリプトを実行してください．
   ```
   python src/register.py
   ```
3. ユーザ名，MACアドレス（すべて小文字），SlackのメンバーIDを順に入力してください．
4. 完了メッセージが出力されたら，Notionのページへ登録されていることを確認してください．


### 既存のメンバーの削除
1. 以下のスクリプトを実行してください．
   ```
   python src/delete.py
   ```
2. 削除したいメンバーのユーザ名を入力し，確認メッセージで`y`を入力してください．
3. 完了メッセージが出力されたら，Notionのページから削除されていることを確認してください．


### 既存のメンバーのMACアドレスの更新
1. 以下のスクリプトを実行してください．
   ```
   python src/update_mac.py
   ```
2. MACアドレスを更新したいメンバーのユーザ名と，新しいMACアドレスを順に入力してください．
3. Notionのページが正しく更新されるようになっていることを確認してください．


### 週次レポートの手動送信
1. 以下のスクリプトを実行してください．
   ```
   python src/send_report_manually.py
   ```
2. 週次レポートを始める最初の時刻を入力してください．例えば，2025/01/01 06:00:00 ~ 2025/01/08 06:00:00の1週間の週次レポートを送信したい場合，次のように入力してください：
   ```
   Input start time (format=%Y/%m/%d %H:%M:%S): 2025/01/01 06:00:00
   ```


## データベースについて
データベースとして，Notionデータベース，SQLite3の2つを用いています．

### Notionデータベース
以下のような，全員に公開する情報が格納されています．
- 現在の入退室状況
- 最終入室時刻
- 累計入室時間

### SQLite3
以下のような，全員には公開すべきでない情報が格納されています．

- 各メンバーのNotionのページID
- 各メンバーのMACアドレス
- 各メンバーのSlackのメンバーID
- 入退室状況が切り替わった時刻


## ログについて
ログはすべて`log/`ディレクトリに保存されています．以下のログが記録されています．

### 入退室記録の開始/終了時刻
`log/start_stop.log`を参照してください．

`main.sh`が開始された時刻，終了された時刻が記録されています．


### 処理中に発生したエラー
`log/error.log`を参照してください．

`main.py`の処理中に発生したエラーが記録されています．主なエラーは以下の通りです：
- NotionのAPIリクエストに起因するもの（タイムアウトなど）
- ネットワーク環境に起因するもの（DNSの名前解決の失敗など）

## その他の仕様
- 週次レポートは，毎週月曜日の朝6時を週の切り替わりとしています．
- データベースの入退室ログと週次レポートの画像は，2週間保存されます．
- 
